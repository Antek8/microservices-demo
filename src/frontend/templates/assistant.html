{{ define "assistant" }}

{{ template "header" . }}
<div {{ with $.platform_css }} class="{{.}}" {{ end }}>
  <span class="platform-flag">
    {{$.platform_name}}
  </span>
</div>

<main role="main">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div id="chat-modal" class="chat-modal">
          <div id="bot-messages" class="bot-messages">
            <p class="bot-message">
              <span class="bot-message-text">Hi, I'm the bot. I can help you with your shopping experience.</span>
            </p>
            <p class="bot-message">
              <span class="bot-message-text">What can I help you with?</span>
            </p>
          </div>
          <div class="bot-input">
            <input id="bot-input-text" type="text" class="bot-input-text" placeholder="Type your message here...">
            <input type="file" onchange="getBase64()">
            <button id="bot-input-button" class="bot-input-button">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  var image;
  function getBase64 ()  {
    var file = document.querySelector('input[type=file]')['files'][0];
    var reader = new FileReader();
    var baseString;
    reader.onloadend = function () {
      baseString = reader.result;
      console.log(baseString);
      image = baseString;
    };
    reader.readAsDataURL(file);
  }

  function extractIdsFromString(message) {
    const idPattern = /\[([a-zA-Z0-9-]+)\]/g;
    const matches = message.matchAll(idPattern);
    const ids = [];
    for (const match of matches) {
      ids.push(match[1]);
    }

    return ids;
  }

  const chatModal = document.getElementById("chat-modal");
  const botMessages = document.getElementById("bot-messages");
  const botbutton = document.getElementById("bot-input-button");
  const botinput = document.getElementById("bot-input-text");

  async function main() {
    botbutton.addEventListener("click", handleButtonClick);

    botinput.addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        botbutton.click();
      }
    });
  }

  async function handleButtonClick() {
    if(!botinput.value || !botinput.value.trim){
      return;
    }
    botMessages.classList.add("loading");
    console.log("bot button clicked");
    const message = botinput.value;
    console.log("message: " + message);
    const usermessage = document.createElement("p");
    const userMessageSpan = document.createElement("span");
    const imageDivElement = document.createElement("div");
    imageDivElement.classList.add("user-image-div")
    const imageElement = document.createElement("img");
    imageElement.src = image;
    imageElement.classList.add("user-image");
    imageElement.onerror = function() { this.style.display = 'none'; }; // Hide on error
    userMessageSpan.innerText = message;
    userMessageSpan.classList.add("user-message-text");
    usermessage.classList.add("user-message");
    usermessage.appendChild(userMessageSpan);
    botMessages.appendChild(usermessage);
    imageDivElement.appendChild(imageElement);
    botMessages.appendChild(imageDivElement);
    botMessages.scrollTo(0, botMessages.scrollHeight);
    botinput.value = "";

    botbutton.disabled = true;
    botinput.disabled = true;
    console.log("bot is typing");

    const response = await fetch("/bot", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        message: message,
        image: image
      }),
    });

    const responseJson = await response.json();
    console.log(responseJson);

    const extractedIds = extractIdsFromString(responseJson.message);
    console.log(extractedIds);

    const botMessage = document.createElement("p");
    const botMessageSpan = document.createElement("span");
    botMessageSpan.innerText = responseJson.message.replace(/\n+\[.*/g, "");
    botMessageSpan.classList.add("bot-message-text");
    botMessage.classList.add("bot-message");
    botMessage.appendChild(botMessageSpan);
    botMessages.appendChild(botMessage);

    if (extractedIds.length > 0) {
      const botProductsDiv = document.createElement("div");
      botProductsDiv.classList.add("bot-products-div");
      for (const id of extractedIds) {
        const botProduct = document.createElement("span");
        botProduct.classList.add("bot-product");
        botProduct.innerText = "https://localhost/products/" + id;
        botProductsDiv.appendChild(botProduct);
      }
      botMessages.appendChild(botProductsDiv)
    }

    botMessages.scrollTo(0, botMessages.scrollHeight);

    botbutton.disabled = false;
    botinput.disabled = false;
    botinput.focus();
    botMessages.classList.remove("loading");
  }

  main();
</script>

{{ end }}
